apiVersion: v1
kind: ConfigMap
metadata:
  name: db-recipe-init-scripts
  namespace: postgresql
data:
  01_schema.sql: |
    CREATE DATABASE mealplanner;

    \c mealplanner;

    CREATE TABLE IF NOT EXISTS recipes (
        id SERIAL PRIMARY KEY,
        name TEXT NOT NULL,
        description TEXT,
        created_at TIMESTAMPTZ DEFAULT NOW(),
        updated_at TIMESTAMPTZ DEFAULT NOW()
    );

    CREATE TABLE IF NOT EXISTS ingredients (
        id SERIAL PRIMARY KEY,
        name TEXT NOT NULL UNIQUE,
        unit TEXT
    );

    CREATE TABLE IF NOT EXISTS recipe_ingredients (
        id SERIAL PRIMARY KEY,
        recipe_id INT REFERENCES recipes(id) ON DELETE CASCADE,
        ingredient_id INT REFERENCES ingredients(id) ON DELETE CASCADE,
        quantity NUMERIC NOT NULL
    );

    CREATE TABLE IF NOT EXISTS mealplans (
        id SERIAL PRIMARY KEY,
        user_id INT,
        week_start DATE NOT NULL,
        created_at TIMESTAMPTZ DEFAULT NOW()
    );

    CREATE TABLE IF NOT EXISTS mealplan_recipes (
        id SERIAL PRIMARY KEY,
        mealplan_id INT REFERENCES mealplans(id) ON DELETE CASCADE,
        recipe_id INT REFERENCES recipes(id) ON DELETE CASCADE,
        day_of_week INT NOT NULL CHECK (day_of_week >= 0 AND day_of_week <= 6)
    );

  02_ingest_data.sql: |
    \c mealplanner;

    -- Ingredients
    INSERT INTO ingredients (name, unit) VALUES
      ('Tomato', 'pcs'),
      ('Pasta', 'grams'),
      ('Chicken Breast', 'grams'),
      ('Olive Oil', 'ml'),
      ('Salt', 'grams');

    -- Recipes
    INSERT INTO recipes (name, description) VALUES
      ('Tomato Pasta', 'Simple tomato pasta recipe'),
      ('Grilled Chicken', 'Easy grilled chicken');

    -- Recipe Ingredients
    INSERT INTO recipe_ingredients (recipe_id, ingredient_id, quantity) VALUES
      (1, 1, 3),   -- 3 Tomatoes for Tomato Pasta
      (1, 2, 200), -- 200g Pasta
      (1, 4, 20),  -- 20ml Olive Oil
      (1, 5, 5),   -- 5g Salt
      (2, 3, 250), -- 250g Chicken Breast
      (2, 4, 15),  -- 15ml Olive Oil
      (2, 5, 5);   -- 5g Salt

      -- Mealplans
      INSERT INTO mealplans (user_id, week_start)
      VALUES
        (1, '2025-12-02');  -- Monday of the week

      -- Mealplan Recipes
      -- day_of_week: 0 = Monday, 6 = Sunday
      INSERT INTO mealplan_recipes (mealplan_id, recipe_id, day_of_week) VALUES
        (1, 1, 0), -- Tomato Pasta on Monday
        (1, 2, 1), -- Grilled Chicken on Tuesday
        (1, 1, 3), -- Tomato Pasta again on Thursday
        (1, 2, 5); -- Grilled Chicken on Saturday
